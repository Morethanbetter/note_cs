# 引论

分布式领域**CAP理论**告诉我们，任何一个分布式系统都无法同时满足Consistency(一致性),Availability(可用性), Partition tolerance(分区容错性) 这三个基本需求。最多只能满足其中两项。

 但是，一个分布式系统无论在CAP三者之间如何权衡，都无法彻底放弃一致性（Consistency），如果真的放弃一致性，那么就说明这个系统中的数据根本不可信，数据也就没有意义，那么这个系统也就没有任何价值可言。所以，无论如何，分布式系统的一致性问题都需要重点关注。

# 数据一致性

通常情况下，我们所说的分布式一致性问题通常指的是**数据**一致性问题。数据一致性是个**逻辑概念**，来源于数据库，可以简单的理解为正确性和完整性，即对数据操作前后的值**和我们的认知逻辑一致**。比如：

- 在单机数据库中，对数据进行写操作之后，新值必须符合目标值。比如做了一个操作（把原来的年龄10加上8），正确性，新值必须是18，不能还是10，或者其他值，这在逻辑上是和我们的认知是一致的。

- 在数据副本模型中，逻辑上需要每个副本的数据是相同的（比如MySQL主从模型）。

- 在跨库操作中，逻辑上需要保证数据能对的上，完整性，不能A扣钱了，B没收到；正确性，A扣的金额=B收到的金额（比如转账案例）。

## 观察角度

不同的观察角度，对一致性有着不同的细致分类。AWS CTO Werner Vogels 从**==客户端和服务端角度==**来叙述数据一致性的概念。

- 客户端：并发访问时更新过的数据如何获取。
- 服务端：更新如何复制分布到整个系统，以保证数据最终一致。

### 客户端角度

从客户端角度观察，数据系统的一致性可分为3种：

- Strong强一致性：数据更新完成后，任何后续访问将会返回最新的数据。
- Weak弱一致性：系统不保证数据更新后的访问会得到最新的数据。客户端获取最新的数据之前需要满足一些特殊条件。此时，从更新到保证任何观察者都能获取到最新。
- Eventually 最终一致性：写入数据后，无法立即读出最新数据，但经过一段时间之后保证最终能读出来。

### 服务端角度

从服务端角度，如何尽快将更新后的数据分布到整个系统，降低达到最终一致性的时间窗口，是提高系统的可用度和用户体验非常重要的方面。对于分布式数据系统：

- N — 数据复制的份数
- W — 更新数据时需保证写完成的节点数
- R — 读取数据时需读取的节点数

如果W+R>N，写的节点和读的节点重叠，则是强一致性。例如对于典型的一主一备同步复制的关系型数据库，N=2,W=2,R=1，则不管读的是主库还是备库的数据，都是一致的。

如果W+R<=N，则是弱一致性。例如对于一主一备异步复制的关系型数据库，N=2,W=1,R=1，则如果读的是备库，就可能无法读取主库已经更新过的数据，所以是弱一致性。

对于分布式系统，为了保证高可用性，一般设置N>=3。不同的N,W,R组合，是在可用性和一致性之间取一个平衡，以适应不同的应用场景。

- 如果N=W,R=1，任何一个写节点失效，都会导致写失败，因此可用性会降低，但是由于数据分布的N个节点是同步写入的，因此可以保证强一致性。
- 如果N=R,W=1，只需要一个节点写入成功即可，写性能和可用性都比较高。但是读取其他节点的进程可能不能获取更新后的数据，因此是弱一致性。这种情况下，如果W<(N+1)/2，并且写入的节点不重叠的话，则会存在写冲突  



